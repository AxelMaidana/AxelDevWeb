<script>
    import Lenis from "lenis";
    import { gsap } from "gsap";
    import { ScrollTrigger } from "gsap/ScrollTrigger";

    gsap.registerPlugin(ScrollTrigger);

    let lenis: Lenis;

    function initLenis() {
        if (lenis) {
            lenis.destroy();
        }

        lenis = new Lenis({
            lerp: 0.1,
            wheelMultiplier: 1,
            infinite: false,
        });

        lenis.on("scroll", ScrollTrigger.update);

        gsap.ticker.add((time) => {
            lenis.raf(time * 1000);
        });

        gsap.ticker.lagSmoothing(0);

        const hash = window.location.hash;
        if (hash && hash !== "#") {
            setTimeout(() => {
                const target = document.querySelector(hash) as HTMLElement;
                if (target) {
                    lenis.scrollTo(target, {
                        immediate: true,
                        offset: -80,
                    });
                }
                ScrollTrigger.refresh();
            }, 100);
        } else {
            lenis.scrollTo(0, { immediate: true });
            setTimeout(() => ScrollTrigger.refresh(), 50);
        }
    }

    initLenis();
    document.addEventListener("astro:page-load", initLenis);

    document.addEventListener("astro:before-swap", () => {
        if (lenis) lenis.destroy();
    });
</script>

<style is:global>
    html.lenis,
    html.lenis body {
        height: auto;
    }

    .lenis.lenis-smooth {
        scroll-behavior: auto !important;
    }

    .lenis.lenis-smooth [data-lenis-prevent] {
        overscroll-behavior: contain;
    }

    .lenis.lenis-stopped {
        overflow: hidden;
    }

    .lenis.lenis-scrolling iframe {
        pointer-events: none;
    }
</style>
