<script>
    import { gsap } from "gsap";
    import { ScrollTrigger } from "gsap/ScrollTrigger";

    gsap.registerPlugin(ScrollTrigger);

    function initAnimations() {
        // Kill existing scroll triggers to prevent memory leaks and conflicts
        ScrollTrigger.getAll().forEach((t) => t.kill());

        const reveals = document.querySelectorAll("[data-reveal='fade-up']");

        reveals.forEach((element) => {
            gsap.fromTo(
                element,
                { opacity: 0, y: 50 },
                {
                    opacity: 1,
                    y: 0,
                    duration: 1,
                    ease: "power3.out",
                    scrollTrigger: {
                        trigger: element,
                        start: "top 90%", // Slightly lower threshold for better performance
                        toggleActions: "play none none reverse",
                    },
                },
            );
        });

        const staggers = document.querySelectorAll("[data-reveal='stagger']");

        staggers.forEach((container) => {
            const children = container.children;

            gsap.fromTo(
                children,
                { opacity: 0, y: 30 },
                {
                    opacity: 1,
                    y: 0,
                    duration: 0.8,
                    ease: "power3.out",
                    stagger: 0.1,
                    scrollTrigger: {
                        trigger: container,
                        start: "top 85%",
                        toggleActions: "play none none reverse",
                    },
                },
            );
        });
    }

    // Delay initialization slightly to prioritize View Transition smoothness
    const handleInit = () => {
        setTimeout(initAnimations, 100);
    };

    handleInit();
    document.addEventListener("astro:page-load", handleInit);
</script>
